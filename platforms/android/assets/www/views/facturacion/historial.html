<script>
	function obtenerFechaHoy(){
	var today = new Date();
		var m = today.getMonth()+1;		// 0-11
		if(m.toString().length<2)
			m="0"+m.toString();
		var y = today.getFullYear();
		var d = today.getDate();
		if(d.toString().length<2)
			d="0"+d.toString();
		var h = today.getHours();
		if(h.toString().length<2)
			h="0"+h.toString();
		var min = today.getMinutes();
		if(min.toString().length<2)
			min="0"+min.toString();
		var s = today.getSeconds();
		if(s.toString().length<2)
			s="0"+s.toString();
		return y+"-"+m+"-"+d+" "+h+":"+min+":"+s;
	}

	function saberFecha(fecha){
	var today = new Date(fecha);
		var m = today.getMonth()+1; // 0-11
		if(m.toString().length<2)
			m="0"+m.toString();
		var y = today.getFullYear();
		var d = today.getDate();
		if(d.toString().length<2)
			d="0"+d.toString();
		return y+"-"+m+"-"+d;
	}

	function convertirTime(strFecha){
		var myDate=strFecha; // 2015-11-11 var myDate="26-02-2012";
		myDate=myDate.split("-");
		var newDate=myDate[0]+"/"+myDate[1]+"/"+myDate[2]+" "+myDate[3]; // var newDate=myDate[1]+"/"+myDate[0]+"/"+myDate[2];
		console.log(newDate);
		return (new Date(newDate).getTime());
	}

	$("#imprimirDetalle").click(function(){
		//alert("imprimir cierre");
		var fechaFiltro=parseInt(convertirTime($("#fechadesde").val()+"-00:00:00"));//1447263393685;//"2015-11-11"; ////$("#select").val();
		var fechaFiltroh=parseInt(convertirTime($("#fechadesde").val()+"-23:59:59"));//1447263393685;//"2015-11-11"; ////$("#select").val();

		fechaRealFiltro=saberFecha(fechaFiltro);
		fechaNow=obtenerFechaHoy();
		numeroFactura="75"; //$("#select").val();
		facturasAnuladas=0;
		var sumaTotales=0;
		var sumaSubtotales=0;
		var sumaIvas=0;
		var sumaDescuentos=0;
		var sumaServicios=0;
		var sumaAnuladas=0;
		var today = new Date().getTime();

		jsonFormaPago=$.parseJSON($("#jsonformaspago").text());
		console.log('misfiltros:'+fechaFiltro+'/'+fechaFiltroh);
		var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
			db.transaction(function(tx){
				tx.executeSql('SELECT * FROM FACTURAS WHERE anulada!=1 and fecha>=? and fecha<=?',[fechaFiltro,fechaFiltroh],function(tx,results){
				strDetalle='';
				intToday=parseInt(today);
				
				var contPasa=0;
					for (var i=0; i <= results.rows.length-1; i++){
						var rowa = results.rows.item(i);
						var fechaFactura = parseInt(rowa.fecha);

						//if(fechaFactura>=fechaFiltro && fechaFactura<=intToday){
						contPasa++;

						
						var formaPago = rowa.paymentsUsed.split(',');
						
						for(j=0;j<=(jsonFormaPago.FormaPago.length-1);j++){
							idForma=jsonFormaPago.FormaPago[j].id;
							nombreForma=jsonFormaPago.FormaPago[j].nombre;
							var cash=0;
							if(formaPago.indexOf(idForma)>=0){
								if(idForma==1){
									cash=parseFloat(rowa.cash)-parseFloat(rowa.echo);
								}
								if(idForma==2){
									var cadena=rowa.cards.split('@');
									for(var k in cadena){
										if(cadena[k]!=''){
											var datocard=cadena[k].split('|');
											cash+=parseFloat(datocard[2]);
										}
									}
								}
								if(idForma==3){
									var cadena=rowa.cheques.split('@');
									for(var k in cadena){
										if(cadena[k]!=''){
											var datocard=cadena[k].split('|');
											cash+=parseFloat(datocard[2]);
										}
									}
								}
								
								if(idForma==4){
									cash=parseFloat(rowa.vauleCxC);
								}
							}
							strDetalle+=idForma+'@'+nombreForma+'@'+cash+"|";
						}
						
						
					
					
						/*var Json = rowa.fetchJson;
						obj=$.parseJSON(Json);*/
						currentTotal=parseFloat(rowa.total);
						sumaTotales=sumaTotales+currentTotal;
						currentSubtotal=parseFloat(rowa.subconiva)+parseFloat(rowa.subsiniva);
						sumaSubtotales=sumaSubtotales+currentSubtotal;
										/*expImp=(obj.Pagar[0].factura.impuestos).split("/");
										iva=parseFloat(expImp[1]);*/
											//sumaIvas = sumaIvas + iva;
						sumaIvas = sumaIvas + parseFloat(rowa.iva);
						sumaDescuentos = sumaDescuentos + parseFloat(rowa.descuento);
						sumaServicios = sumaServicios + parseFloat(rowa.servicio);
					}
					
					tx.executeSql('SELECT count(*) as c FROM FACTURAS WHERE anulada=1 and fecha>=? and fecha<=?',[fechaFiltro,fechaFiltroh],function(tx,results2){
						if(results2.rows.length>0){
							var item=results2.rows.item(0);
							if(item.c!=null){
								sumaAnuladas=item.c;
							
							if(contPasa){
								strDetalle=strDetalle.substring(0,strDetalle.length-1);
								nFacturas=results.rows.length;
								var respuesta = imprimirDetalle(fechaNow,fechaRealFiltro,nFacturas,sumaSubtotales.toFixed(2),sumaTotales.toFixed(2),sumaIvas.toFixed(2),sumaServicios.toFixed(2),sumaDescuentos.toFixed(2),strDetalle,sumaAnuladas);
								var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
								db.transaction(function(tx){
										tx.executeSql("SELECT printer FROM CONFIG where id=1",[],function(tx,results){
										//console.log(results);
										if(results.rows.length>0){
											//alert(results.rows.item(0).printer);
											var idprinter=results.rows.item(0);
											if(idprinter.printer!=''){
												var now=new Date().getTime();
												tx.executeSql("INSERT INTO logactions (time,descripcion,datos) values (?,?,?)",[now,"Envia imprimir Cierre",respuesta]);
												StarIOAdapter.rawprint(respuesta,idprinter.printer, function() {
													showalert("Imprimiendo Cierre de Caja");
													var now=new Date().getTime();
													tx.executeSql("INSERT INTO logactions (time,descripcion,datos) values (?,?,?)",[now,"Se imprimió el Cierre",""]);
												});
											}else{
												showalert("No se ha configurado una impresora.");
											}
										}
									});
								},errorCB,successCB);
								/*window.open('centvia://?udn=Impresion&utt=NubePOS&cru=NubePOS+V2&c_='+respuesta,'_system','location=yes');*/
							}else{
								alert("No existen facturas en este rango de fechas");
							}

						}
						}
					});
				});
			},errorCB,successCB);
	});

function SinTildes(word){
  word=word.replace("á","a");
  word=word.replace("Á","A");
  word=word.replace("é","e");
  word=word.replace("É","E");
  word=word.replace("í","i");
  word=word.replace("Í","I");
  word=word.replace("ó","o");
  word=word.replace("Ó","O");
  word=word.replace("ú","u");
  word=word.replace("Ú","U");
  word=word.replace("ñ","n");
  word=word.replace("Ñ","N");
  return word;
}

function imprimirDetalle(fechaNow,fechaRealFiltro,nFacturas,subtotales,totales,ivas,servicios,descuentos,strDetalle,anuladas){
		console.log(fechaNow);
		console.log(fechaRealFiltro);
		console.log(subtotales);
		console.log(totales);
		console.log(ivas+'/'+servicios+'/'+descuentos);
		console.log(strDetalle);
		jsonFormaPago=$.parseJSON($("#jsonformaspago").text());
		strImprimir = '"formaspago":[{';
		var cont=0;
		var BR='%0d%0a';
									for(k=0;k<=(jsonFormaPago.FormaPago.length-1);k++){
										idForma=jsonFormaPago.FormaPago[k].id;
										nombreForma=jsonFormaPago.FormaPago[k].nombre;
										exp=strDetalle.split("|");
										sumaCurrent=0;
										for(h=0;h<=(exp.length-1); h++){
											cash=0;
											exp2=exp[h].split("@");
											cash=parseFloat(exp2[2]);
											idCurrent=exp2[0];

											if(idCurrent==idForma){
												sumaCurrent=sumaCurrent+cash;
											}
										}
										cont=cont+40;
										espacio=340+cont;
										//strImprimir+="TEXT+7+0+20+"+espacio+"+"+nombreForma+"+$"+parseFloat(sumaCurrent).toFixed(2)+"+"+BR;
										if(idForma==1)
											sumaCurrent=sumaCurrent;
										
										strImprimir+='"'+nombreForma+'":"'+parseFloat(sumaCurrent).toFixed(2)+'"';
										if(k<jsonFormaPago.FormaPago.length-1)
											strImprimir+=",";
									}
						strImprimir+="}]";
						console.log(strImprimir);

numeroFactura=0;
nombreCliente="josue";
rucCliente='TEXTO DUMMY JOSUE';
pagoForm=0;
subnoiva='0';
subiva=0;
iva=0;
descuen=0;
total=0;
valor="0 @0 ";

 var serv = '0.00';

  var nombrelocal = 'DETALLE DE CAJA';
  var baseu='';
  var extend=espacio;//430;
  var f = new Date();
  var midate= f.getFullYear() + "-" + (f.getMonth() +1) + "-" + f.getDate();
  var hora=f.getHours();
  var min=f.getMinutes();
  var seg=f.getSeconds();
  finali=extend+100;
  dosIvas=parseFloat(ivas).toFixed(2);
  dosServicios=parseFloat(servicios).toFixed(2);
  dosDescuentos=parseFloat(descuentos).toFixed(2);
  dosTotal=(parseFloat(totales)).toFixed(2);
  /*txt_titleHead="TEXT+4+0+20+10+DETALLE+DE+CAJA" + BR;
  txt_linea1="TEXT+7+0+20+60+Fecha+caja+"+fechaRealFiltro + BR;
  txt_linea2="TEXT+7+0+20+100+Fecha+de+impresion+"+fechaNow+BR;
  txt_linea3="TEXT+7+0+20+140+Numero+de+facturas+"+nFacturas+BR;
  txt_linea4="TEXT+7+0+20+200+Facturas+anuladas+0"+BR;
  txt_linea5="TEXT+7+0+20+240+SUBTOTAL+$"+subtotales+BR;
  txt_linea6="TEXT+7+0+20+280+IVA+$"+dosIvas+BR;
  txt_linea7="TEXT+7+0+20+320+TOTAL+$"+dosTotal+BR;
  txt_linea8="TEXT+7+0+20+"+finali+"+"+BR;*/
  var subdesc=(subtotales-dosDescuentos).toFixed(2);
  txt_linea='{"Cierre": [{"fecha_caja":"'+fechaRealFiltro+'","fecha_imp":"'+fechaNow+'","num_facts":"'+nFacturas+'","fact_anuladas":"'+anuladas+'","subtotal":"'+subtotales+'","iva":"'+dosIvas+'","servicio":"'+dosServicios+'","descuento":"'+dosDescuentos+'","subdesc":"'+subdesc+'","total":"'+dosTotal+'",'+strImprimir+'}]}';
  //extend=extend+100;
  //baseu+="TEXT+4+0+20+10+"+SinTildes(nombrelocal).replace(" ","+")+"%0d%0aTEXT+7+0+20+60+"+SinTildes(nombreCliente).replace(" ","+")+"-RUC."+rucCliente+"%0d%0aTEXT+7+0+20+110+"+midate+"+"+hora+"%3a"+min+"%3a"+seg+"%0d%0a";
  //baseu+="%0d%0aTEXT+7+0+20+60+"+SinTildes(nombreCliente).replace(" ","+")+"-RUC."+rucCliente+"%0d%0aTEXT+7+0+20+110+"+midate+"+"+hora+"%3a"+min+"%3a"+seg+"%0d%0a";
	//baseu+=BR + txt_titleHead + txt_linea1 + txt_linea2 + txt_linea3 + txt_linea4 + txt_linea5 + txt_linea6 + txt_linea7 + strImprimir + txt_linea8 ;
  //var ins="!+0+200+200+"+extend+"+1%0d%0a"+baseu+"%0d%0aPRINT%0d%0a";
  //return ins;
  console.log(txt_linea);
  return txt_linea;
}

</script>

<style>
.fa-edit{
	color:#23ae89;
}
.fa-edit:hover{
	color:#404041;
}
</style>
<div id="mainDiv" class='row'>
		<div class='col-lg-12 col-sm-12 col-md-12'>
		<div class='row' style='margin-bottom:10px;'>
			<div class='col-lg-12 col-md-12 col-sm-12'  style='padding-top:10px; padding-bottom:10px; background-color:white;'><h3>Historial de Facturas</h3></div>
		</div>
		<div class='row' style='padding-top:10px; padding-bottom:10px; background-color:white;'>
			<div class='col-lg-6 col-sm-6 col-md-6' style='padding-left:20px;'>
				<table align='left' border="0" cellpadding="4px" cellspacing="10px">
						<tr>
							<td style='vertical-align:middle;'>
								<input placeholder='Desde' type="text" class='form-control' id="fechadesde" name="fechadesde" style='margin:5px;' readonly />
							</td>
							<td  style='vertical-align:middle;'>
                                <button type='button' class="btn btn-primary" onclick="page=0; getSearch(); return false;">Filtrar</button>
							</td>

						</tr>
				</table>
			</div>
			<div class='col-lg-6 col-sm-6 col-md-6'>
				<table align='right' style="text-align:center; margin-left: 0px; margin-right: auto;" border="0" cellpadding="4px" cellspacing="10px">
						<tr>
							<td  style='vertical-align:middle;'>
								  <button class="btn btn-success" style="margin-right:15px;" id="imprimirDetalle" type="button" >Imprimir Cierre de Caja</button>
							</td>

							<td  style='vertical-align:middle; padding-right:20px;'>
                                <b>TOTAL$</b><br/><span id="totalencabezado"></span>
							</td>
						</tr>
					</table>
			</div>
		</div>
		<div class='row'>
		<div class='col-lg-12 col-md-12 col-sm-12' style='margin-top:10px;'>
		<div id='contentdetail' style='overflow-x:hidden; overflow-y:auto;'>
		<table style="width:100%;" border="0" cellpadding='10px' class='table table-striped'>
			<tr>
				<td colspan="2">
					<div id="detailDiv" style="height:100%; padding-top:20px; margin:0px; font-size:15px;"></div>
				</td>
			</tr>
			<tr>
				<td colspan='2'>
					<ul class="pagination pagination-lg">
				  </ul>
				</td>
			</tr>
            <tr>
				<td colspan="2" style="background-color: #FFFFFF;">
                    <div id="detailDiva" style="height:100%;padding-top:20px;font-size:15px;background-color: #FFFFFF;"></div>
				</td>
			</tr>
			<tr style="display: none;">
				<td colspan="2" style='text-align:center;'>
					<ul class="pagination paginacion-lg" id='paginacion'>
					</ul>
					<input id='totalpags' style='display:none;'/>
				</td>
			</tr>
		</table>
		</div>
		</div>
		</div>
		</div>
</div>

<script type="text/javascript">
var page=1;

$(document).ready(function(){

$('#contentdetail').css("height",parseInt($(window).height())*57/100);
$('#fechahasta,#fechadesde').datepicker({"dateFormat":"yy-mm-dd"});

var fechahoyaux=new Date();
fechahoyaux=parseInt(fechahoyaux.getTime());
fechahoyaux=new Date(fechahoyaux);
var meshoy=parseInt(fechahoyaux.getMonth())+1;
    if(meshoy.toString().length<2)
    	meshoy="0"+meshoy.toString();
var fechahoyformataux=fechahoyaux.getFullYear()+"-"+meshoy+"-"+fechahoyaux.getDate();

//console.log(fechahoy.getTime());
//var fechamenos=parseInt(fechahoy.getTime())-(7*86400000);
//console.log(fechamenos);
/*var fechaanterior=new Date(fechamenos);
var mesant=parseInt(fechaanterior.getMonth())+1;
if(mesant.toString().length<2)
	mesant="0"+mesant.toString();
var fechaantformat=fechaanterior.getFullYear()+"-"+mesant+"-"+fechaanterior.getDate();*/

//$('#fechadesde').val(fechaantformat);
$('#fechadesde').val(fechahoyformataux);
//$('#fechahasta').val(fechahoyformat);

//si no tiene permisos
	var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
	db.transaction(function(tx){
	if(localStorage.getItem("permisos")=="true"){
		tx.executeSql("SELECT id from permisos where clave like ? and impcierre=?",[localStorage.getItem("claveuser"),"true"],function(tx,results2){
			if(results2.rows.length>0){
				if(results2.rows.item(0).id!=null){
					$('#imprimirDetalle').fadeIn();
				}else{
					$('#imprimirDetalle').fadeOut();
				}
			}else{
					$('#imprimirDetalle').fadeOut();
			}
		});
	}else{
		$('#imprimirDetalle').fadeIn();
	}
	});
//permisos

getSearch();
});

function getSearch(){
	//console.log($('#fechadesde').val());
	var filtrodesde=convertirTime($('#fechadesde').val()+"-00:00:00");
	var filtrohasta=convertirTime($('#fechadesde').val()+"-23:59:59");
	var queryextra=' id is not NULL';
	if(filtrodesde!='')
		queryextra+=' and fecha >='+filtrodesde+' and fecha <='+filtrohasta+' ';

	var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
	db.transaction(function(tx){
	
	tx.executeSql('SELECT count(*) as c FROM FACTURAS WHERE '+queryextra,[],function(tx,result){
		$('.pagination').html('');
			var npags=Math.ceil(parseInt(result.rows.item(0).c)/30);
			$('#totalpags').val(npags);
			$('.pagination').append("<li onclick='CambiarPagina(-1);'><span class='enabled' id='atras'>&laquo;</span></li>");
			for(var t=1;t<=npags;t++){
				var act='';
				if(page==t)
					act='active';
				$('.pagination').append("<li class='"+act+"' onclick='CambiarPagina("+parseInt(t)+");'><span class='enabled'>"+parseInt(t)+"</span></li>");
			}
			$('.pagination').append("<li onclick='CambiarPagina(-2);'><span class='enabled' id='adelante'>&raquo;</span></li>");
	});
	
	var miquery='SELECT * FROM FACTURAS WHERE '+queryextra+' ORDER BY fecha desc limit 30 offset '+((page-1)*30);
	tx.executeSql(miquery,[],function(tx,results){
		var inhtml='';
		var totalfinal=0;
		for (var i=0; i < results.rows.length; i++){
			var row = results.rows.item(i);
			//console.log(row.fecha);
			var timefecha=new Date(row.fecha);
			var mes=timefecha.getMonth()+1;
			if(mes.toString().length<2)
				mes="0"+mes.toString();
			var fechaformat=("00" + timefecha.getDate()).slice(-2)+"/"+mes+"/"+timefecha.getFullYear()+" "+("00" + timefecha.getHours()).slice(-2)+":"+("00" + timefecha.getMinutes()).slice(-2)+":"+("00" + timefecha.getSeconds()).slice(-2);
			//console.log(row);
			var mifunc="EditarFactura("+row.id+");";
			/*var datosfact=JSON.parse(row.fetchJson);*/
			var totalf=(parseFloat(row.total)).toFixed(2);
			var anulada='No';
			if(row.anulada==1){
				anulada='Si';
            }else{
                totalfinal += parseFloat(totalf);
            }
			inhtml+='<tr><td>'+fechaformat+'</td><td>'+row.clientName+'</td><td>'+row.RUC+'</td><td>'+row.nofact+'</td><td>'+anulada+'</td><td style="text-align:right;">'+totalf+'</td><td><button class="btn btn-default btn-sm" onclick="'+mifunc+'"><span class="glyphicon glyphicon-pencil"></span></button></td></tr>';
		}
		LlenarTablaFacturas(inhtml);
		$('#totalencabezado').html(totalfinal.toFixed(2));
	});
	
	},errorCB,successCB);
}

function LlenarTablaFacturas(datos){
	$('#detailDiv').html("<table align='center' class='table table-hover table-striped'><tr><th>Fecha</th><th>Cliente</th><th>RUC</th><th># Factura</th><th>Anulada</th><th style='text-align:right;'>Total US</th><th style='text-align:right;width: 50px;'></th>"+datos+"</table>");
}
function LlenarTablaFacturasp(datosp){
	$('#detailDiva').html("<div style='background-color: #FFFFFF;'><table align='right' class='table' style='width: 25%;'><tr><th colspan='2' style='text-align:center;'>Formas de Pago</th><th style='text-align:right;width: 50px;'></th></tr>"+datosp+"</table><div>");
}
function LlenarTablaFacturasau(datosau){

  console.log(datosau+'**');
	$('#tablaformapago').append(datosau);
}

function CambiarPagina(arg){
	//console.log($('#totalpags').val());
	if(arg==-1){
		if((page-1)>=1){
			page--;
			getSearch();
		}
	}else if(arg==-2){
		//console.log($('#totalpags').val());
		if((page)<parseInt($('#totalpags').val())){
			page++;
			getSearch();
		}
	}else{
		page=arg;
		getSearch();
	}

}

$(document).keyup(function(event){
	if(event.keyCode === 13){
		getSearch();
		}
});

function EditarFactura(idfactura){
	$('#main').load("views/facturacion/editarfactura.html",function(){
		VerDatosFactura(idfactura);
	});
}
</script>
