<div class='row'>
	<div class='col-lg-12'>
		<div class='panel panel-default'>
			<h3 id="trans_label_19">Configuración de Impresoras</h3>
			<div class='panel-body'>
				 <div class='col-lg-12' style='text-align:right;'>
				 <button type='button' onclick='BuscarImpresoras();' class='btn btn-success trans_search'>Buscar Impresoras</button>
				 </div>
				<div class='col-lg-12' style='padding:20px;'>
				<table class='table table-striped table-bordered' id='listaimpresoras'>
					<thead>
					<tr><th id='trans_label_11'>Nombre</th><th id='trans_label_20'>Elegir</th></tr>
					</thead>
					<tbody>
					</tbody>
				</table>
				<div class='col-lg-12' style='text-align:right;'>
					<button id='btnsetear' class='btn btn-success' style='display:none;' onclick='SetearImpresora();'>Elegir</button>
					<button id='btnprobar' class='btn btn-success' style='display:none;' onclick='ImprimirTest();'>Imprimir Prueba</button>
				</div>
				</div>
				<div class='col-lg-12' style='margin-top:20px;'>
					<p style='text-align:left; padding-left:10px'><b id='trans_label_21'>Preferencias</b></p>
					<div>
						<table class='table table-border'>
							<tr>
							<td><span id='trans_label_22'>Tamaño Encabezado</span> (cm):</td>
							<td><input class='form-control' type='number' onkeytouch="" id='encabezado' name='encabezado'/></td>
							<td><span id='trans_label_23'>Largo Factura</span> (cm):</td>
							<td><input class='form-control' type='number' id='largo' name='largo'/></td>
							</tr>
						</table>
						<div style='text-align:right'>
							<button class="btn btn-success trans_update" type='button' onclick='ActualizarMedidas();'>Actualizar</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<script>
	$(document).ready(function(){
		//idioma
		var xmlidioma=$.get("lang/en.xml",function(d){
			var itemestructura=$(d).find("estructura")[0];
			var itemtitles=$(itemestructura).find("titles")[0];
			var itembuttons=$(itemestructura).find("botones")[0];
			var itemlabels=$(itemestructura).find("labels")[0];
			var todostitles=$(itemtitles).find("item");
			var todosbuttons=$(itembuttons).find("item");
			var todoslabels=$(itemlabels).find("item");	
				for(var k=0;k<todostitles.length;k++){
					var miitemname=$(todostitles[k]).attr("name");
					//alert(miitemname);
					$('.'+miitemname).html($(todostitles[k]).html());
				}
				
				for(var k=0;k<todosbuttons.length;k++){
					var miitemname=$(todosbuttons[k]).attr("name");
					//alert(miitemname);
					$('.'+miitemname).html($(todosbuttons[k]).html());
				}
				
				for(var k=0;k<todoslabels.length;k++){
								var miitemname=$(todoslabels[k]).attr("name");
								$('#'+miitemname).html($(todoslabels[k]).html());
							}
				
		});
		
		BuscarImpresoras();
	});
	
	function BuscarImpresoras(){
		//alert("hola impresora");
		$('#listaimpresoras tbody').html('');
		var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
		db.transaction(
		function (tx){
			tx.executeSql('SELECT encabezado,largo FROM CONFIG WHERE id=1;',[],
			function(tx,res){
				if(res.rows.length>0){
					$('#encabezado').val(res.rows.item(0).encabezado);
					$('#largo').val(res.rows.item(0).largo);
				}
			});				
		},errorCB,successCB);
		
		//StarIOAdapter.searchall("USB:SN:00123456",function(dataprint){
		StarIOAdapter.searchall("",function(dataprint){
			var linea1="<tr><td>No print</td><td><input class='printerradio' data-value='0' type='radio' name='printer' value='0' id='print_0' checked /></td></tr>";
			$('#listaimpresoras tbody').append(linea1);
			//alert(res);
			var res=dataprint.split('@');
			//alert(res[0]+''+res[1]);
			var linea="<tr><td>"+res[1]+"</td><td><input class='printerradio' data-value='"+res[0]+"' type='radio' name='printer' value='"+res[0]+"' id='print_"+res[0]+"'/></td></tr>";
			$('#listaimpresoras tbody').append(linea);
			if($('#listaimpresoras tbody').html()!=''){
					$('#btnsetear,#btnprobar').fadeIn();
					var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
					db.transaction(function(tx){
						tx.executeSql("SELECT printer FROM CONFIG where id=1",[],function(tx,results){
							console.log(results);
							var idprinter='';
							if(results.rows.length>0){
								var idprinter=results.rows.item(0);
								if(idprinter.printer!=null){
									//alert(idprinter.printer);
									//$('#print_'+idprinter.printer).prop('checked','checked');
									$('#print_'+idprinter.printer).prop('checked','true');
									$('.printerradio').each(function(){
										//alert($(this).attr("id"));
										if($(this).attr("id")=="print_"+idprinter.printer)
											$(this).prop("checked",true);
											$(this).prop("checked","true");
											$(this).prop("checked","checked");
									});
								}
							}
						});},errorCB,successCB);
			}else{
				$('#btnsetear,#btnprobar').css("display","none");
			}
				
		}, function(error){
			var linea="<tr><td>No print</td><td><input class='printerradio' data-value='0' type='radio' name='printer' value='0' id='print_0' checked /></td></tr>";
			$('#listaimpresoras tbody').append(linea);
			showalert("Ocurrió un problema con la impresora, vaya a configuracion: " + error);
		});

		
	}
	
	function SetearImpresora(){
		var laprinter='';
		laprinter=$('.printerradio:checked').val();
		//alert($('input:radio[name=printer]:checked').val());
		/*$('.printerradio').each(function(){
			if($(this).is(":checked")){
				laprinter=$(this).attr("data-value");
				break;
			}
		});*/
		//alert(laprinter);
		if(laprinter!=null){
			var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
			var cuantos=0;
			if(laprinter==0)
				laprinter='';
			db.transaction(function(tx1){
				tx1.executeSql("SELECT count(*) as c from CONFIG",[],
				function(tx1,results1){
					if(results1.rows.length>0){
						if(results1.rows.item(0).c>0){
							tx1.executeSql("UPDATE CONFIG SET printer=? where id=1",[laprinter],function(tx1,results2){
								showalert("Se ha vinculado la impresora: "+laprinter);
							});
						}else{
							tx1.executeSql("INSERT INTO CONFIG (printer) VALUES (?)",[laprinter],function(tx1,results3){
								showalert("Se ha vinculado la impresora: "+laprinter);
							});
							
						}
					}
				});}
			,errorCB,successCB);
				
			
			/*if(cuantos==1){
				db.transaction(function(tx){
					tx.executeSql("UPDATE CONFIG SET printer=? where id=1",[laprinter],function(tx,results){
						//console.log(results);
						//alert(laprinter);
						showalert("Se ha vinculado la impresora: "+laprinter);
					});},errorCB,successCB);
			}else{
				db.transaction(function(tx3){
					tx3.executeSql("INSERT INTO CONFIG (printer) VALUES (?)",[laprinter],function(tx3,results3){
						//console.log(results3);
						//alert(laprinter);
						showalert("Se ha vinculado la impresora: "+laprinter);
				});},errorCB,successCB);
			}*/
		}
	}
	
	function ImprimirTest(){
		//alert("test");
		var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);		
		db.transaction(function(tx){
			tx.executeSql("SELECT printer FROM CONFIG where id=1",[],function(tx,results){
			//console.log(results);
			if(results.rows.length>0){
				//alert(results.rows.item(0).printer);
				var idprinter=results.rows.item(0);
				console.log(idprinter);
				if(idprinter.printer!=null){
					//alert(idprinter.printer);
					StarIOAdapter.rawprint($('#jsonprint').html(),idprinter.printer, function() {
						showalert("Imprimiendo Test");
					});
				}else{
					showalert("No se ha configurado una impresora.");
				}
			}
			});
		},errorCB,successCB);
	}
	
	function ActualizarMedidas(){
		var db = window.openDatabase("Database", "1.0", "PractisisMobile", 200000);
		db.transaction(
		function (tx){
			var encab=3;
			if(parseInt($('#encabezado').val())>0)
				encab=$('#encabezado').val();
			var largo=18;
			if(parseInt($('#largo').val())>0)
				largo=$('#largo').val();
				
			tx.executeSql('UPDATE CONFIG set encabezado=?,largo=? WHERE id=1;',[encab,largo],
			function(tx,res){
				localStorage.setItem("encabezado",encab);
				localStorage.setItem("largo",largo);
				showalert("Actualizado con éxito.");
			});				
		},errorCB,successCB);
	}
</script>